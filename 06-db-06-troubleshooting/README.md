# Домашнее задание к занятию 6. «Troubleshooting»

### Выполнил Хайруллин Ильнур


## Задание 1
Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB. 

## Ответ:

Список операций для остановки запроса, если включен проф:
- Зайду в логи mongodb и отфильтрую запросы по длительности (180с и больше)  db.currentOp({"secs_running":{$gte: 180}})
- Принудительно завершу процесс, который висит  db.killOp(id процесса)

Вариант решения с долгими запросами:
- Увеличить вычислительные ресурсы (физически или в конфиг файле)
- Создать индексы на частые запросы (если база данных большая)
- Можно попробовать  настроить планировщик, для построения лучшего плана запроса (explain(‘executionStats’))

## Задание 2
Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.


### Ответ:

Скорее всего установлен большой TTL, а количество данных увеличивается быстрее, чем истекает TTL старых. Поэтому заканчивается выделенная память и блокируется запись.

## Задание 3
Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?


## Ответ:

При увеличении базы запросы селект начали выполняться дольше и не укладываются в установленные тайм ауты.

Пути решения (https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html):
- Увеличить net_read_timeout в конфигах mysql, чтобы не разрывалась сессия при запросах с большой выборкой
- Возможно у клиента медленное сетевое соединение, тогда увеличиваем connect_timeout, время для установления сессии
- Увеличить max_allowed_packet, если отправляются большие пакеты со значениями (BLOB)

## Задание 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?


## Ответ:

Судя по ошибке убивается процесс,потому что заканчивается выделенная память .

Проблему можно решить правильным распределением памяти, выставление максимального значения и доступного для приложения значения.
Чтобы oom-killer не завершал важные процессы , можно выставить oom_score_adj = -1000 для postrgesql. 